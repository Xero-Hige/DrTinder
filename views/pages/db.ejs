<!DOCTYPE html>
<html>
<head>
	<% include ../partials/header.ejs %>
	<script type ="text/javascript" src="scripts/chosen.jquery.min.js"></script>
</head>

<body>
<% function isSpecialKey(key){ %>
	<% specialKeys = ["interests","location","photo_profile"]; %>
	<% return (specialKeys.indexOf(key) >= 0); %>
<% } %>

<% function interesesPorCategoria(interests) { %>
	<% var interesesOrdenados = {}%> 
	<% interests.forEach(function(cat){ %>
		<% if (!(cat.category in interesesOrdenados)){ %>
			<% interesesOrdenados[cat.category]=[cat.value]; %>
		<% } else { %>
		<% interesesOrdenados[cat.category].push(cat.value); %>
		<% } %>
	<% }); %>
	<% return interesesOrdenados%>
<% } %>
	<!--Lista categorias intereses completa-->
	<% var interesesOrdenadosTodos = interesesPorCategoria(intereses);%>
	<% include ../partials/nav.ejs %>
	<div class="container" data-link="<%= link %>">
		<header>
			<h2>Usuarios en Base de Datos</h2> 
			<button id="crear_usuario_pop" class="btn mini red-stripe" data-toggle="modal" 
			data-target="#new_user">Crear Usuario</button>
		</header>                

		<table class="table table-striped table-hover table-users" id="dataBase">
			<thead>
				<tr>
					<!--Header users attributes-->
					<th class = "col-lg-1 col-md-1 col-sm-2 col-xs-3"></th>
					<% if (!results[0]){ %>
						</tr></thead></table></div>
					<% }else{ %>
					<% var keys = Object.keys(results[0].user); %>
					<% keys.forEach(function (key){ %>
					<% if ( isSpecialKey(key) ) { %>
					
					<% } else {%>
					<th class = "col-lg-1 col-md-1 col-sm-2 col-xs-3"><%= key %></th>
					<% } %>
					<% }); %>
					<th class = "col-lg-1 col-md-1 col-sm-2 col-xs-3">interests</th>
					<th class = "col-lg-1 col-md-1 col-sm-2 col-xs-3">location</th>
					<th class = "col-lg-1 col-md-1 col-sm-2 col-xs-3">photo</th>

				</tr>
			</thead>
			<tbody>
				<!--Body users attributes-->
				<% results.forEach(function(r) { %>
				<% var id = r.user["id"] %>
				<tr id ="<%= id %>">
					<td class = "col-lg-1 col-md-1 col-sm-2 col-xs-3" >
						<span class="glyphicon glyphicon-pencil edit-user" ></span>
					</td>
					<% for (var i = 0; i < keys.length; i++) { %>
					<% var value = r.user[keys[i]]; %>
					<% if ( isSpecialKey(keys[i]) ) { %>
					
					<% } else {%>
					<td class = "col-lg-1 col-md-1 col-sm-2 col-xs-3 <%= keys[i]%>"><%= value %></td>
					<% } %>
					<% } %>
					
					<!--lista de categorias-->
					
					<% var interesesOrdenados = interesesPorCategoria(r.user["interests"]);%>


					<td class = "col-lg-1 col-md-1 col-sm-2 col-xs-3 interests">
						<div class="btn-group"> 
							<button class="btn btn-default dropdown-toggle" type="button" id="drop-int-<%= id %>" data-toggle="dropdown">
								Ver <span class="glyphicon glyphicon-plus"></span>
							</button>

							<ul class="dropdown-menu interests" aria-labelledby="drop-int-<%= id %>">

								<% for (key in interesesOrdenados){ %>
								<li class="dropdown-header"><%= key %></li>
								<% interesesOrdenados[key].forEach(function(val){ %>
								<li><%= val%></li>
								<% }); %>
								<% } %>

							</ul>
						</div>
					</td>
					<% var location = r.user["location"];%>
					<td class = "col-lg-1 col-md-1 col-sm-2 col-xs-3 location">
						<div class="btn-group"> 
							<button class="btn btn-default dropdown-toggle" type="button" id="drop-loc-<%= id %>" data-toggle="dropdown">
								Ver <span class="glyphicon glyphicon-plus"></span>
							</button>
							<ul class="dropdown-menu" aria-labelledby="drop-loc-<%= id %>">

								<% for (key in location){ %>
								<li class="dropdown-header"><%= key %></li>
								<li data-loc="<%= key %>"><%= location[key] %></li>

								<% } %>
							</ul>
						</div>
					</td>

					<% var data = r.user["photo_profile"]; %>
					<td class = "col-lg-1 col-md-1 col-sm-2 col-xs-3 photo">
						<span class="glyphicon glyphicon-search" data-value="<%= data %>" ></span>
					</td>
				</tr>
				<% }); %>
			</tbody>
		</table>
	</div>
	<div id="img_user" class="modal fade" role="dialog">
		<div class="modal-dialog modal-sm">

			<!-- Modal content -->
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<div class="modal-body">
					<img id="img_a_buscar" class="img-responsive" />
				</div>
			</div>
		</div>
	</div>

	<div id="profile_user" class="modal fade" role="dialog">
		<div class="modal-dialog modal-lg">

			<!-- Modal content -->
			<div class="modal-content">
				<div class="modal-header">
					<span id="profile_id" class="pull-left"></span>
					<span id="profile_mail"  class="pull-right"> </span>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="col-md-6">
							<img id="profile_photo" class="img-responsive" />
							<div class="form-group">
								<label for="profile_photo_file">Choose File for photo</label>
								<input type="file" class="form-control" id="profile_photo_file" />
							</div>
						</div>
						<div class="col-md-6">
							<div class="form-group">
								<label for="profile_name">Name</label>
								<input type="text" class="form-control" id="profile_name" />
							</div>
							<div class="form-group">
								<label for="profile_alias">Alias</label>
								<input type="text" class="form-control" id="profile_alias" 
								placeholder="ContraseÃ±a">
							</div>
							<div class="form-group">
								<label for="profile_sex">Sex</label>
								<select class="form-contorl" id="profile_sex">
									<option value="man">M</option>
									<option value="woman">F</option>
								</select>
							</div>
							<div class="form-group">
								<label for="profile_age">Age</label>
								<input type="text" class="form-control" id="profile_age" 
								placeholder="Age">
							</div>
							<label for="profile_location">Location</label>
							<form class="form-inline">
								<div class="form-group" style="margin-bottom:15px;">
									<input type="number" class="form-control input-medium" id="profile_longitude" placeholder="Longitude"> 
									<input type="number" class="form-control input-medium" id="profile_latitude" placeholder="Latitude"> 
								</div>  
							</form>
							<div class="form-group">
								<label for="profile_interests">Interests</label>
								<select id="profile_interests" data-placeholder="Choose interests" class="chosen-select" multiple tabindex="5">
									<option value=""></option>
									<% for (category in interesesOrdenadosTodos){ %>
									<!-- active-result a result-selected -->
									<optgroup label="<%= category %>" >
										<% interesesOrdenadosTodos[category].forEach(function(value){ %>
										<option><%= value%></option>
										<% }); %>
										<% } %>
									</optgroup>
								</select>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button class="btn btn-default pull-left" id="delete_user">Delete</button>
					<button class="btn btn-default pull-right" id="save_user">Save</button>
				</div>
			</div>
		</div>
	</div>

	<div id="error_msg" class="modal fade" role="dialog">
		<div class="modal-dialog modal-lg">
			<!-- Modal content -->
			<div class="modal-content">
				<div class="modal-header">Error</div>
				<div class="modal-body"></div>
			</div>
		</div>
	</div>
	<% }%>
	<!-- Modal -->
	<div id="new_user" class="modal fade" role="dialog">
		<div class="modal-dialog">

			<!-- Modal content-->
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title">Crear Usuario</h4>
				</div>
				<div class="modal-body">
					

					<div class = "list-group">
						<!--Chosen con itereses-->
						<div class="list-group-item">
							<em>Interests</em>
							<select data-placeholder="Choose interests" class="chosen-select" multiple tabindex="5">
								<option value=""></option>
								<% for (category in interesesOrdenadosTodos){ %>
								<optgroup label="<%= category %>" >
									<% interesesOrdenadosTodos[category].forEach(function(value){ %>
									<option><%= value%></option>
									<% }); %>
									<% } %>
								</optgroup>
							</select>
						</div>

						<!--Atributos basicos-->
						<% ['name','alias','age','email'].forEach(function (key) { %>
						<% if ( isSpecialKey(key) || key == "id" || key == "sex") { %>

						<% } else { %>
						<div class = "list-group-item">
							<div class="input-group basic_info">

								<span class="input-group-addon" ><%= key %></span>
								<input type="text" class="form-control" id = "crear_<%= key %>">


							</div>
						</div>
						<% } %>
						
						<% }); %>
						<!--Location-->
						<div class = "list-group-item">
							<div class="input-group basic_info">

								<span class="input-group-addon" >sex</span>
								<select type="text" class="form-control" id="crear_sex">
									<option value="woman">woman</option>
									<option value="man">man</option>
								</select>

							</div>
						</div>
						<!--Location-->
						<div class = "list-group-item">
							<div class="input-group" id="location_crear">
								<span class="input-group-addon" >location</span>
								<input type="text" class="form-control input-sm" placeholder="latitude" />
								<input type="text" class="form-control input-sm" placeholder="longitude" />
							</div>
						</div>

						<!--Photo-->
						<div class = "list-group-item">
							<div class="input-group">
								<span class="input-group-addon" >photo_profile</span>
								<input id="photo_file" class="form-control input-sm" type="file" />
								<img id="photo_to_send" src="" style="display: none" />
							</div>
						</div>
					</div>

					<div class="modal-footer">
						<div id="err_msg"></div>
						<button id="crear_user" type="button" 
						class="btn btn-default" 
						data-loading-text="<i class='fa fa-spinner fa-spin '></i>" >
							Crear
						</button>
					</div>
				</div>

			</div>
		</div>
	</div>
	<script type="text/javascript" src="scripts/show_img.js"></script>
	<link rel="stylesheet" type="text/css" href="stylesheets/bootstrap-chosen.css" />
	<script type="text/javascript" src="scripts/modify_profile.js"></script>

</body>

</html>
